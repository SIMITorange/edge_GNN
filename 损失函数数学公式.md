# 损失函数数学公式汇总（edge_GNN）

本文档给出训练中使用的复合损失（CompositeLoss）的数学表达，便于归档与论文写作。设目标集合为 T（例如 ElectrostaticPotential, ElectricField_x, ElectricField_y, SpaceCharge），图顶点集 V，边集 E。对某一目标 t ∈ T，记预测为 p_t(v)，真实值为 y_t(v)，节点位置 r_v。

总体复合损失：
L = Σ_{t∈T} w_t [ α_t L1_t + β_t RelL1_t ] + λ_s L_smooth + λ_g L_grad + λ_c L_curv + λ_reg L_reg

其中权重由配置提供（示例：w_t=1）；超参示例：α_t=1.0..2.0, β_t=0.8, λ_s=0.08, λ_g=0.15, λ_c=0.05, λ_reg=1e-5(可设0)。

1) 点间绝对误差（L1）
L1_t = (1/|V|) Σ_{v∈V} | p_t(v) - y_t(v) |

2) 相对 L1（避免对量纲大值过度主导）
RelL1_t = (1/|V|) Σ_{v∈V} | p_t(v) - y_t(v) | / ( |y_t(v)| + ε )
其中 ε = 1e-8（或更大，视归一化而定）。

3) 平滑项（Edge-based Laplacian smoothing）
常用形式（edge-wise）：
L_smooth = (1/|E|) Σ_{(i,j)∈E} ( p̄(i) - p̄(j) )^2
这里 p̄ 可以是某一目标或对所有目标加权的组合；也可用归一化后的值或物理量。可用权重 w_ij = 1/|r_i - r_j| 来强调近邻：
L_smooth = (1/Σ w_ij) Σ_{(i,j)∈E} w_ij ( p(i) - p(j) )^2

4) 梯度一致性项（edge-wise gradient）
在边上估算一维投影梯度：
g_e^p = ( p(j) - p(i) ) / |r_j - r_i|  ，  g_e^y 同理
L_grad = (1/|E|) Σ_{e∈E} ‖ g_e^p - g_e^y ‖_2
对于向量场（ElectricField_x, ElectricField_y）可分别计算并合并：
L_grad = (1/|E|) Σ_e sqrt( (g_{e,x}^p - g_{e,x}^y)^2 + (g_{e,y}^p - g_{e,y}^y)^2 )

5) 曲率项（二阶导/离散 Laplacian 的一致性）
离散拉普拉斯算子（基于逆距离权重）：
Δ p(i) = Σ_{j∈N(i)} w_ij ( p(j) - p(i) ),  w_ij = 1/|r_j - r_i|
然后：
L_curv = (1/|V|) Σ_{i∈V} ( Δ p^p(i) - Δ p^y(i) )^2

6) 参数正则 / 输出 L2（可选）
- 参数权重衰减（optimizer weight_decay）或
- 输出 L2（目标级别）
L_reg = (1/|V|) Σ_{v∈V} ( p(v) - y(v) )^2

7) 针对场限环/高场峰值的加权（可选）
为使高场区域（尖峰）被更重视，可在上述项中加入位置相关权重 s(v)：
s(v) = 1 + γ · sigmoid( (|E(v)| - E0)/E0 )
加权后的 L1（示例）：
L1_t^w = (1/Σ s(v)) Σ_v s(v) · | p_t(v) - y_t(v) |
推荐 E0 取典型场强量级（例如 1e5），γ 取 5~20，或使用幂函数 s(v)=|E(v)|^ρ（ρ≈0.25..1）谨慎使用以免不稳。

8) 关于归一化与导数项的计算空间
- 建议对点值预测使用归一化输入（训练稳定），但**对梯度/曲率类项应在物理尺度上计算**（即对网络输出执行 normalizer.inverse 后再计算差分），以保证导数具有正确的量纲和相对权重。若在归一化空间计算，需乘以相应缩放因子恢复物理量单位。

9) 实践中常用组合（示例）
L_total = Σ_t w_t [ 2.0·L1_t + 0.8·RelL1_t ] + 0.08·L_smooth + 0.15·L_grad + 0.05·L_curv
（并将 L_reg 设置为 0 以允许过拟合，若需泛化再启用较小的 weight_decay）

10) 数值稳定建议
- RelL1 的 ε 不宜过小（1e-6 ~ 1e-8 根据归一化而定）
- 计算边长 |r_j - r_i| 时避免为 0（加 1e-8）
- 对极端权重做裁剪（s(v) 最大阈值）

----

参考实现要点
- 在实现 CompositeLoss 时，将 per-target losses 返回为 dict（便于日志打印：L1, RelL1, Smooth, Grad, Curv）
- 在训练日志中按目标分别打印 L1/RelL1，并打印聚合 loss（每 10 epoch）
- 若电场峰值未被学习，优先尝试：
  1) 在 loss 中对电场使用峰值加权 s(v)
  2) 在梯度/曲率项中强制使用物理尺度
  3) 适当增加 L_grad 权重或降低 L_smooth

结束。