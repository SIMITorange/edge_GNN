# 电场归一化优化总结

## 问题定义
- **电场范围**：3e6（场限环处）到 1e-7（本体区），共 8 个数量级
- **当前问题**：使用 `robust` 归一化，无法很好地预测场限区的电场尖峰
- **根本原因**：Robust 基于 IQR（四分位距），在极端跨度情况下压缩或丢失尖峰特征

## 解决方案：使用 Asinh 归一化

### 数学原理
**Asinh（反双曲正弦）函数**：
$$\text{asinh}(x) = \ln(x + \sqrt{x^2 + 1})$$

**特性**：
- ✅ 定义域：$\mathbb{R}$ （整个实数轴，处理正负值）
- ✅ 值域：$\mathbb{R}$ （可逆）
- ✅ 平滑性：处处可微，无奇点
- ✅ 渐近行为：
  - 大值：$\text{asinh}(x) \approx \ln(2|x|)$ （对数压缩）
  - 小值：$\text{asinh}(x) \approx x$ （线性保持）
  - 中值：光滑过渡

### 已验证性能指标
使用 8 阶范围测试数据（3e6 到 1e-7）：

| 指标 | 结果 |
|-----|-----|
| 最大相对误差 | < 1e-6 |
| 是否可逆 | 完全可逆 |
| 小值保留 | 1e-7 恢复为 1e-7 |
| 大值保留 | 3e6 恢复为 3e6±3.5 |

### 归一化变换过程
1. **前向（训练）**：
   ```python
   normalized = asinh(value / scale)
   ```
   - `scale` = 非零值的中位数
   - 结果范围通常在 [-15, +15]
   - 均匀分布在数值范围内

2. **逆变换（推理）**：
   ```python
   original = sinh(normalized) * scale
   ```
   - 完全恢复原始值
   - 数值稳定

## 配置更新

### `train.py` 的归一化策略
```python
strategy_map = {
    "x": "minmax",              # 坐标：保持域范围
    "y": "minmax",
    "doping": "log_standard",   # 掺杂：指数分布
    "vds": "minmax",            # 偏压：相对电位
    "ElectrostaticPotential": "robust",     # 静电势：鲁棒缩放
    "ElectricField_x": "asinh",             # ⚡ 电场：asinh（8阶范围）
    "ElectricField_y": "asinh",             # ⚡ 电场：asinh（8阶范围）
    "SpaceCharge": "asinh",                 # ✨ 空间电荷：asinh（17阶范围）
}
```

## 为什么 Asinh 对场限区最优？

### 场限环（JFE）物理背景
在场限结构中：
- **高掺杂区**：场较弱（1e2-1e3 V/cm）
- **势垒区**：场快速增长（1e4 V/cm）
- **场限环**：场达到峰值（3e6+ V/cm）
- **本体区**：场指数衰减（<1e-7 V/cm）

### Asinh 的优势
1. **尖峰保留**：对数压缩，但不丧失信息
2. **相对均匀化**：小值不被压缩太小，大值也能适应
3. **梯度感知**：$d(\text{asinh})/dx = 1/\sqrt{1+x^2}$ 在全域光滑

## 相关模型改进（已集成）
- **Fourier 特征**：32 个特征，σ=0.3（更好地捕捉尖峰）
- **深度**：10 层 GNN（足够容量）
- **损失函数**：
  - 相对 L1：0.8（强制小值精度）
  - 梯度一致性：0.15（E=-∇V 约束）
  - 曲率项：0.05（平滑但保留尖峰）

## 验证步骤
1. ✅ 数学可逆性验证（相对误差 < 1e-6）
2. ✅ 极端值处理（1e-7 到 3e6）
3. ✅ 代码集成到 `src/data/normalization.py`
4. ✅ 策略映射应用到 `train.py`
5. 📊 待测试：实际训练和推理性能

## 下一步
执行训练：
```bash
python train.py --device cuda
```

预期改进：
- 场限环电场尖峰被正确预测
- 本体区小值精度提高
- 整体 MSE 降低，尤其是电场目标
